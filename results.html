<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Election Results - RMEDUSC</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fafbfd; margin:0; padding:24px; }
    .container { max-width:700px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.06); }
    h1 { color:#007bff; }
    .controls { margin:12px 0 18px; display:flex; gap:12px; align-items:center; }
    select { padding:8px 10px; border-radius:6px; border:1px solid #d0d7de; }
    button { padding:8px 12px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
    .post { border:1px solid #eef2f6; padding:12px; border-radius:8px; margin-top:18px; }
    .post h3 { margin:0 0 8px; font-size:1rem; }
    .bars { display:flex; flex-direction:column; gap:8px; }
    .barWrap { display:flex; align-items:center; gap:12px; }
    .label { width:220px; }
    .bar { height:18px; background:#e9ecef; border-radius:9px; width:100%; overflow:hidden; }
    .fill { height:100%; background:#28a745; width:0%; transition:width .45s ease; }
    .count { min-width:36px; text-align:right; }
    .debug { color:#dc3545; font-size:0.95em; margin:8px 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Election Results â€” Reveal Votes</h1>
    <p>Select a post and press "Reveal next vote" to reveal votes one at a time. Bars update cumulatively.</p>
    <div class="controls">
      <label for="postSelect">Post</label>
      <select id="postSelect"><option value="">-- select post --</option></select>
      <button id="revealBtn" disabled>Reveal next vote</button>
      <button id="resetReveal">Reset reveal</button>
    </div>
    <div id="posts"></div>
    <div id="debugPosts" class="debug"></div>
  </div>
  <script>
    function loadAllVotes() {
      try {
        const data = sessionStorage.getItem('all_votes');
        return data ? JSON.parse(data) : {};
      } catch (e) {
        console.error(e);
        return {};
      }
    }

    const postSelect = document.getElementById('postSelect');
    const revealBtn = document.getElementById('revealBtn');
    const resetReveal = document.getElementById('resetReveal');
    const postsEl = document.getElementById('posts');
    const debugPosts = document.getElementById('debugPosts');

    let revealIndex = 0;
    let revealList = [];
    let tallies = {};
    let candidates = [];
    let selectedPost = '';

    // Auto-generate post selector from actual vote data
    function populatePostSelector() {
      const allVotes = loadAllVotes();
      const votes = Object.values(allVotes);
      let postKeys = [];
      if (votes.length > 0 && votes[0].selections) {
        postKeys = Object.keys(votes[0].selections);
      }
      postSelect.innerHTML = '<option value="">-- select post --</option>';
      postKeys.forEach(post => {
        const opt = document.createElement('option');
        opt.value = post;
        opt.textContent = post;
        postSelect.appendChild(opt);
      });
      debugPosts.textContent = 'Detected post keys: ' + postKeys.join(', ');
    }

    function buildUIForPost(post) {
      postsEl.innerHTML = '';
      const allVotes = loadAllVotes();
      // Gather all votes for all batches
      const votes = Object.values(allVotes).sort((a,b) => new Date(a.timestamp) - new Date(b.timestamp));
      // Only keep votes that have the selected post
      const filteredVotes = votes.filter(v => v.selections && v.selections[post]);
      revealList = filteredVotes; revealIndex = 0;
      tallies = {};
      candidates = [];
      selectedPost = post;

      if (filteredVotes.length === 0) {
        postsEl.innerHTML = '<p>No votes recorded yet for this post.</p>';
        revealBtn.disabled = true;
        return;
      }

      // Determine candidate list by scanning all votes
      const candidateSet = new Set();
      filteredVotes.forEach(v => {
        const val = v.selections[post];
        if (val) candidateSet.add(val);
      });
      candidates = Array.from(candidateSet);
      candidates.forEach(name => { tallies[name] = 0; });

      // Create UI block for the post
      const div = document.createElement('div');
      div.className = 'post';
      const title = document.createElement('h3');
      title.textContent = post;
      div.appendChild(title);
      const bars = document.createElement('div');
      bars.className = 'bars';
      candidates.forEach(name => {
        const wrap = document.createElement('div');
        wrap.className = 'barWrap';
        const label = document.createElement('div'); label.className='label'; label.textContent = name;
        const bar = document.createElement('div'); bar.className='bar';
        const fill = document.createElement('div'); fill.className='fill'; fill.style.width='0%';
        const count = document.createElement('div'); count.className='count'; count.textContent='0';
        bar.appendChild(fill);
        wrap.appendChild(label);
        wrap.appendChild(bar);
        wrap.appendChild(count);
        bars.appendChild(wrap);
      });
      div.appendChild(bars);
      postsEl.appendChild(div);
      revealBtn.disabled = false;
    }

    function revealNext() {
      if (revealIndex >= revealList.length) return;
      const vote = revealList[revealIndex];
      const choice = vote.selections[selectedPost];
      if (choice) tallies[choice] = (tallies[choice] || 0) + 1;
      revealIndex++;
      updateBars();
      if (revealIndex >= revealList.length) revealBtn.disabled = true;
    }

    function updateBars() {
      const postDiv = postsEl.querySelector('.post');
      if (!postDiv) return;
      const wraps = postDiv.querySelectorAll('.barWrap');
      const total = Object.values(tallies).reduce((a,b)=>a+b,0) || 0;
      candidates.forEach((name, i) => {
        const wrap = wraps[i];
        const count = tallies[name] || 0;
        const percent = total === 0 ? 0 : Math.round((count/total)*100);
        const fill = wrap.querySelector('.fill');
        const countEl = wrap.querySelector('.count');
        fill.style.width = percent + '%';
        countEl.textContent = count;
      });
    }

    postSelect.addEventListener('change', () => {
      const post = postSelect.value;
      if (!post) {
        postsEl.innerHTML = '';
        revealBtn.disabled = true;
        return;
      }
      buildUIForPost(post);
    });

    revealBtn.addEventListener('click', revealNext);
    resetReveal.addEventListener('click', () => {
      if (!postSelect.value) return;
      buildUIForPost(postSelect.value);
    });

    // On page load, auto-populate post selector
    populatePostSelector();
  </script>
</body>
</html>